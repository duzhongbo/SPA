<script type="text/javascript">
$(function () {
	// 文章列表模型
	var M = Backbone.Model.extend({
		defaults : {
			data : aData.article
		}
	});

	// 文章列表视图
	var V = Backbone.View.extend({
		initialize : function () {
			this.show();
		},
		show:function (model) {
			$('.index-article-ul').html(this.template(this.model.toJSON()));
		},
		template:_.template($('#template').html()),
		el:$('body'),
		events:{
			'click a':'showDetail',
		},
		showDetail:function (e) {
			var target = e.target || e.srcElement;
			var url = $(target).attr('href');
			location.hash='article'+url;
			return false;
		}
	});
	var m = new M;
	var v = new V({model:m});

	// 导航视图
	var vNav = Backbone.View.extend({
		el:$('.nav'),
		events:{
			'click a':'nav'
		},
		nav:function (e) {
			var target = e.target || e.srcElement;
			var href = $(target).attr('href');
			switch(href){
				case '/':
					location.hash = '';
					break;
				case '/tags':
					console.log('标签页');
					break;
				default:;
			}
			return false;
		}
	})
	var vNav1 = new vNav;
	// 路由与历史管理
	var Workspace = Backbone.Router.extend({
		routes: {
			'':'index',// 只有域名的情况,首页
			'article/:year/:month/:date/:title':'showDetail',// #article/kiwis
		},
		showDetail:function (year,month,date,title) {
			var url = '/'+year+'/'+month+'/'+date+'/'+title,temp1,temp2;
			for(var i=0,data=aData.article,len=data.length;i<len;i++){
				temp1 = data[i];
				temp2 = decodeURI(temp1.url);
				if(temp2==url){
					$('.article-title').html(temp1.title);
					$('.article-content').html(html_decode(temp1.content));
					$('.article-date').html(temp1.date);
					$('.article').show();
					$('.index-article-ul').hide();
				}
			}
		},
		index:function () {
			$('.article').hide();
			$('.index-article-ul').show();
		}
	});

	var w = new Workspace;
	Backbone.history.start();

	// 将已经转义的html标签重新转回
	function toHtml (str) {
		var reg = /&lt;/g,reg2 = /&gt;/g;
		str = str.replace(reg,'<');
		str = str.replace(reg2,'>');
		return str;
	}
	function html_decode(str){   
	  var s = "";   
	  if (str.length == 0) return "";   
	  s = str.replace(/&gt;/g, ">");   
	  s = s.replace(/&lt;/g, "<");   
	  s = s.replace(/&nbsp;/g, " ");   
	  s = s.replace(/&quot;/g, "\"");   
	  s = s.replace(/<br>/g, "\n");
	  s = s.replace(/class/g,' class');
	  s = s.replace(/src/g,' src');
	  return s;   
	}
});


</script>
